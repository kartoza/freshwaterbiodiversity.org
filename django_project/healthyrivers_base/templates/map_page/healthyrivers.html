{% extends 'map_page/bims.html' %}
{% load static from staticfiles %}
{% load grunt %}


{% block extra_head %}
    <link href="{% static "js/libs/openlayers-4.6.4/ol.css" %}" rel="stylesheet">
    <script src="{% static 'js/libs/openlayers-4.6.4/ol.js' %}"></script>
    <link href="{% static "css/healthyrivers-map.css" %}" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
{% endblock %}

{% block additional_template %}
    <div id="detailed-dashboard" style="display: none">
    <button class="btn btn-primary btn-dashboard" style="float: right" onclick="$('#detailed-dashboard').hide('slide', {direction: 'right'}, 300)"><i class="fa fa-times pull-right"></i></button>
    <div class="container dashboard-wrapper">
        <div>
            <h3>Overview</h3>
        </div>
        <div class="container row">
            <div class="col-lg-4">
                <div id="locationsite-map" class="map" style="height: 300px; width: 100%; border: 1px solid black"></div><button id="export-locationsite-map" class="btn btn-default btn-element-download"><i class="fa fa-download"></i></button>
                <div id="overview-dashboard-table" class="dashboard-table" style="margin-top: 10px; margin-bottom: 10px">
                    <table>
                        <tr>
                            <td>Name</td>
                            <td id="site-name"></td>
                        </tr>
                        <tr>
                            <td>Records</td>
                            <td id="total-records"></td>
                        </tr>
                    </table>
                </div>
                <span><b>Occurence data</b></span>
                <div id="occurence-table" class="dashboard-table">
                </div>
            </div>
            <div class="col-lg-8" id="dashboard-graph-wrapper">
                <span><b>Fish</b></span>
                <div>
                    <div class="row" style="margin: 0 !important;">
                        <div style="width: 90%">
                            <table style="width: 100%; text-align: center; border: 1px solid black">
                                <tr>
                                    <td id="fish-category-wrapper" class="chart-wrapper" width="33%">
                                        <canvas id="fish-category-graph" width="150px" height="150px"></canvas>
                                    </td>
                                    <td width="33%">
                                        <canvas id="cons-status-graph" width="150px" height="150px"></canvas>
                                    </td>
                                    <td width="33%">
                                        <canvas id="sampling-method-graph" width="150px" height="150px"></canvas>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Origin</td>
                                    <td>Cons status</td>
                                    <td>Sampling method</td>
                                </tr>
                            </table>
                        </div>
                        <div style="width: 10%;">
                            <button class="btn btn-default btn-element-download pull-right" onclick="download(document.getElementById('fish-category-wrapper'), 'origin')"><i class="fa fa-download"></i></button>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin: 0 !important; margin-top: 15px !important;">
                    <div id="record-timeline-wrapper" class="chart-wrapper" style="border: 1px solid black; width: 90%; height: 200px">
                        <canvas id="records-timeline-graph" width="150px" height="150px"></canvas>
                    </div>
                    <div style="width: 10%;">
                        <button class="btn btn-default btn-element-download pull-right" onclick="download(document.getElementById('record-timeline-wrapper'), 'record-timeline')"><i class="fa fa-download"></i></button>
                    </div>
                </div>
                <div class="row" style="margin: 0 !important; margin-top: 15px !important;">
                    <div id="fish-timeline-wrapper" class="chart-wrapper" style="border: 1px solid black; width: 90%; height: 200px">
                        <canvas id="fish-timeline-graph" width="150px" height="150px"></canvas>
                    </div>
                    <div style="width: 10%;">
                        <button class="btn btn-default btn-element-download pull-right" onclick="download(document.getElementById('fish-timeline-wrapper'), 'fish-timeline')"><i class="fa fa-download"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script type='text/html' id='site-dashboard-template'>
        <div id="healthyrivers-side-panel" class="right-panel-header-healthyrivers">
            <div class="row healthyrivers-site-detail">
                <div class="col-lg-12 healthyrivers-table-title">
                    <span>SPECIES DATABASE BREAKDOWN</span>
                </div>
                <div class="col-lg-12" style="padding: 0">
                    <table>
                        <tr>
                            <td><img src="{% static 'img/fish-2.svg' %}" height="100px"><br/><span id="fish-occurence-count">0</span></td>
                            <td><img src="{% static 'img/invertebras-2.svg' %}" height="100px"><br/><span id="invertebra-occurence-count">0</span></td>
                            <td><img src="{% static 'img/algae-2.svg' %}" height="100px"><br/><span id="algae-occurence-count">0</span></td>
                        </tr>
                        <tr>
                            <td width="33%">
                                <canvas id="fish-graph" width="50px" height="50px"></canvas>
                            </td>
                            <td width="33%">
                                <canvas id="invertebrates-graph" width="50px" height="50px"></canvas>
                            </td>
                            <td width="33%">
                                <canvas id="algae-graph" width="50px" height="50px"></canvas>
                            </td>
                        </tr>
{#                        <tr>#}
{#                            <td width="33%">#}
{#                                <span class="endemic-title">EN</span><span id="fish-endemic-num" class="endemic-total">43</span>#}
{#                            </td>#}
{#                            <td width="33%">#}
{#                                <span class="endemic-title">EN</span><span id="invertebrates-endemic-num" class="endemic-total">12</span>#}
{#                            </td>#}
{#                            <td width="33%">#}
{#                                <span class="endemic-title">EN</span><span id="algae-endemic-num" class="endemic-total">4</span>#}
{#                            </td>#}
{#                        </tr>#}
                        <tr>
                            <td width="33%">
                                <canvas id="fish-calculation-graph" width="50px" height="50px"></canvas>
                            </td>
                            <td width="33%">
                                <canvas id="invertebrates-calculation-graph" width="50px" height="50px"></canvas>
                            </td>
                            <td width="33%">
                                <canvas id="algae-calculation-graph" width="50px" height="50px"></canvas>
                            </td>
                        </tr>
                        <tr>
                            <td width="33%">
                                <canvas id="fish-pie-chart-major" width="50px" height="50px"></canvas>
                            </td>
                            <td width="33%">
                                <canvas id="invertebrates-pie-chart-major" width="50px" height="50px"></canvas>
                            </td>
                            <td width="33%">
                                <canvas id="algae-pie-chart-major" width="50px" height="50px"></canvas>
                            </td>
                        </tr>
                        <tr>
                            <td width="33%">
                                <canvas id="fish-pie-chart-minor" width="50px" height="50px"></canvas>
                            </td>
                            <td width="33%">
                                <canvas id="invertebrates-pie-chart-minor" width="50px" height="50px"></canvas>
                            </td>
                            <td width="33%">
                                <canvas id="algae-pie-chart-minor" width="50px" height="50px"></canvas>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="row healthyrivers-side-panel-footer">
                <div class="col-lg-3"><i class="fa fa-link"></i></div>
                <div class="col-lg-7" style="line-height: 60px"><span style="text-decoration: underline">Detailed dashboard</span></div>
                <div class="col-lg-2"><a onclick="renderDetailedDashboard()"><i class="fa fa-arrow-right"></i></a></div>
            </div>
        </div>
    </script>
    <script>
        var locationSitePk = null;
        function renderDetailedDashboard() {
            $('#detailed-dashboard').show('slide', {direction: 'right'}, 300);
            renderLocationSiteMap();
            console.log(locationSiteData);
            locationSitePk = locationSiteData['id'];

            $('#site-name').html(locationSiteData['name']);
            $('#total-records').html(fishNumber);
            $.getScript('/static/scripts/render-data-graph.js')
        }

        function renderLocationSiteMap() {
            var locationSiteGeometry = JSON.parse(locationSiteData['geometry']);
            var center = ol.proj.transform([locationSiteGeometry['coordinates'][0], locationSiteGeometry['coordinates'][1]], 'EPSG:4326', 'EPSG:3857')
            var mapLocationSite = new ol.Map({
                layers: [
                  new ol.layer.Tile({
                    source: new ol.source.OSM()
                  })
                ],
                target: 'locationsite-map',
                view: new ol.View({
                  center: center,
                  zoom: 12
                })
            });
            var iconFeatures=[];
            var iconFeature = new ol.Feature({
                  geometry: new ol.geom.Point(center)
            });

            var iconStyle = new ol.style.Style({
                image: new ol.style.Icon(({
                    anchor: [0.5, 46],
                    anchorXUnits: 'fraction',
                    anchorYUnits: 'pixels',
                    opacity: 0.75,
                    src: '/static/img/map-marker.png'
                }))
            });

            iconFeature.setStyle(iconStyle);
            iconFeatures.push(iconFeature);

            var vectorSource = new ol.source.Vector({
              features: iconFeatures
            });

            var vectorLayer = new ol.layer.Vector({
              source: vectorSource
            });
            mapLocationSite.addLayer(vectorLayer);

            document.getElementById('export-locationsite-map').addEventListener('click', function() {
                mapLocationSite.once('postcompose', function(event) {
                  var canvas = event.context.canvas;
                  if (navigator.msSaveBlob) {
                    navigator.msSaveBlob(canvas.msToBlob(), 'map.png');
                  } else {
                    canvas.toBlob(function(blob) {
                      saveAs(blob, 'map.png');
                    });
                  }
                });
                mapLocationSite.renderSync();
            });
        }


        function createDataGraph(container, data, barType, labels, options, colorOptions) {
            var myChart = new Chart(container, {
                type: barType,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colorOptions['backgroundColor'],
                        borderColor: colorOptions['borderColor'],
                        borderWidth: 1
                    }]
                },
                options: options
            });
        }
        function createPieChart(container, data, labels, options, colorOptions) {
            var myPieChart = new Chart(container, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colorOptions,
                        borderWidth: 1
                    }]
                },
                options: options
            });
        }
        var locationSiteData;
        var fishNumber = 0;
        function renderDashboard(data) {
            $('#dashboard-detail').find('.search-result-title').html('INDICATOR SUMMARY');
            var $detailWrapper = $('<div></div>');
            var dashboardTemplate = _.template($('#site-dashboard-template').html());
            $detailWrapper.append(dashboardTemplate());
            return $detailWrapper;
        }

        function calculateChart(dashboardDiv, data) {
            var barOptions = {
                scales: {
                    xAxes: [{
                        gridLines: {
                            display: false
                        },
                        ticks: {
                            autoSkip: false,
                            maxRotation: 90,
                            minRotation: 90,
                            padding: -100,
                            fontColor: '#000000',
                            fontStyle: 'bold',
                        },
                        categoryPercentage: 1,
                        barPercentage: 1,
                    }],
                    yAxes: [{
                        gridLines: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            display: false
                        }
                    }]
                },
                legend: {
                    display: false
                }
            };

            var barColor = {
                'backgroundColor': [
                    'rgba(222, 210, 65, 0.5)',
                    'rgba(98, 156, 68, 0.5)',
                    'rgba(62, 80, 50, 0.5)'
                ],
                'borderColor': [
                    'rgba(222, 210, 65,1)',
                    'rgba(98, 156, 68, 1)',
                    'rgba(62, 80, 50, 1)'
                ]
            };

            var options = {
                layout: {
                    padding: {
                        left: -10,
                        right: 0,
                        top: 0,
                        bottom: 0
                    }
                },
                scales: {
                    yAxes: [{
                        gridLines: {
                            display: false
                        },
                        ticks: {
                            autoSkip: false,
                            padding: -120,
                            fontColor: '#000000',
                            fontStyle: 'bold',
                        },
                        categoryPercentage: 1,
                        barPercentage: 1,
                    }],
                    xAxes: [{
                        gridLines: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            display: false
                        }
                    }]
                },
                legend: {
                    display: false
                }
            };

            var horizontalBarColor = {
                'backgroundColor': [
                    'rgba(236, 230, 150, 0.5)',
                    'rgba(222, 210, 65, 0.5)',
                    'rgba(242, 237, 182, 0.5)'
                ],
                'borderColor': [
                    'rgba(0, 0, 0, 1)',
                    'rgba(0, 0, 0, 1)',
                    'rgba(0, 0, 0, 1)'
                ]
            };

            var pieData = [25, 2, 7, 10, 12, 25, 60];
            var pieLabel = ['grey', 'black', 'red', 'orange', 'yellow', 'lightgreen', 'green'];
            var pieColor = ['grey', 'black', 'red', 'orange', 'yellow', 'lightgreen', 'green'];
            var pieOptions = {
                legend: {
                    display: false
                },
                cutoutPercentage: 0,
                maintainAspectRatio: false
            };

            var recordOccurrence = data['records_occurrence'];
            var speciesRichness = 0;
            fishNumber = 0;
            locationSiteData = data;
            $.each(recordOccurrence, function (index, object) {
                speciesRichness += Object.keys(object).length;
                $.each(object, function (key, value) {
                    fishNumber += value['count']
                })
            });

            var fishOccurenceCount = $(dashboardDiv.find('#fish-occurence-count').get(0));
            fishOccurenceCount.html(fishNumber);

            var shannonDiversity = countShannonDiversity(recordOccurrence, fishNumber);
            var simpsonDiversity = countSimpsonDiversity(recordOccurrence, fishNumber);
            var speciesEvenness = countSpeciesEvenness(shannonDiversity, speciesRichness);

            try {
                var fishGraph = dashboardDiv.find('#fish-graph').get(0).getContext('2d');
                var fishCalculationGraph = dashboardDiv.find('#fish-calculation-graph').get(0).getContext('2d');
                var fishPieChartMajor = dashboardDiv.find('#fish-pie-chart-major').get(0).getContext('2d');

                var categories = data['modules_info']['fish']['categories'];
                var native = 0;
                var nonNative = 0;
                var translocated = 0;

                if (categories.hasOwnProperty('indigenous')) {
                    native = categories['indigenous'];
                }
                if (categories.hasOwnProperty('alien')) {
                    nonNative = categories['alien'];
                }
                if (categories.hasOwnProperty('translocated')) {
                    translocated = categories['translocated'];
                }

                createDataGraph(fishGraph, [native, nonNative, translocated], 'bar', ["Native", "Non-Native", "Translocated"], barOptions, barColor);
                createDataGraph(fishCalculationGraph, [speciesRichness, shannonDiversity, speciesEvenness], 'horizontalBar', ["Species Richness", "Shannon Diversity", "Species Evenness"], options, horizontalBarColor);
                createPieChart(fishPieChartMajor, pieData, pieLabel, pieOptions, pieColor);
            } catch (err) {
                setTimeout(calculateChart, 100);
            }
        }

        function countShannonDiversity(data, totalOccurrence) {
            var shannonNum = 0;
            $.each(data, function (index, object) {
                $.each(object, function (key, value) {
                    var piShannon = value['count'] / totalOccurrence;
                    shannonNum += piShannon * Math.log(piShannon);
                })
            });
            shannonNum = -shannonNum;
            return shannonNum
        }

        function countSimpsonDiversity(data, totalOccurrence) {
            var n = 0;
            $.each(data, function (index, object) {
                $.each(object, function (key, value) {
                    n += value['count'] * (value['count'] - 1);
                })
            });
            var simpsonNum = n / (totalOccurrence * (totalOccurrence - 1));
            return simpsonNum
        }

        function countSpeciesEvenness(shannonDiversity, totalSpecies) {
            var Hmax = Math.log(totalSpecies);
            var speciesEvenness = shannonDiversity / Hmax;
            return speciesEvenness
        }

        function download(canvas, title) {
           html2canvas(canvas, {
              onrendered: function(canvas) {
                 var link = document.createElement('a');
                 link.href = canvas.toDataURL('image/jpeg');
                 link.download = title + '.jpeg';
                 link.click();
              }
           })
        }
    </script>

{% endblock %}